@inherits LoginModalBase

@if (Visible)
{
    <div id="loginModal" class="modal fade show d-block" tabindex="-1" style="background:rgba(33,33,33,0.22); z-index: 6000;">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-fill-lock me-2"></i>@(IsRequestMode ? "Demande d'accès" : IsForgotMode ? "Mot de passe oublié" : "Connexion")</h5>
                    <button type="button" class="btn-close" aria-label="Fermer" @onclick="Hide"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">@ErrorMessage</div>
                    }
                    @if (IsRequestMode)
                    {
                        @if (RequestSent)
                        {
                            <div class="alert alert-success">Demande envoyée. Nous vous recontacterons rapidement.</div>
                        }
                        else
                        {
                            @if (!string.IsNullOrWhiteSpace(NoAccountInfo))
                            {
                                <div class="mb-3">@((MarkupString)RenderedNoAccountInfo)</div>
                            }
                            <EditForm Model="AccessRequestModel" OnValidSubmit="HandleAccessRequest">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                <div class="mb-3">
                                    <label>Email</label>
                                    <InputText class="form-control" @bind-Value="AccessRequestModel.Email" />
                                </div>
                                <div class="mb-3">
                                    <label>Message</label>
                                    <InputTextArea class="form-control" @bind-Value="AccessRequestModel.Message" Rows="4" />
                                </div>
                                <button class="btn btn-success w-100" type="submit" disabled="@IsBusy">
                                    Demander un accès à la boutique
                                    @if (IsBusy)
                                    {
                                        <span class="spinner-border spinner-border-sm ms-2"></span>
                                    }
                                </button>
                            </EditForm>
                        }
                        <button class="btn btn-link w-100 mt-2" @onclick="ShowLogin">Se connecter</button>
                    }
                    else if (IsForgotMode)
                    {
                        @if (ForgotSent)
                        {
                            <div class="alert alert-success">Si un compte existe, un lien magique vous a été envoyé.</div>
                            <button class="btn btn-link w-100 mt-2" @onclick="ShowLogin">Se connecter</button>
                        }
                        else
                        {
                            <div class="mb-3">merci de renseigner votre mail, un nouveau lien magique vous permettra de vous connecter automatiquement si votre compte existe.</div>
                            <EditForm Model="ForgotModel" OnValidSubmit="HandleForgotPassword">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                <div class="mb-3">
                                    <label>Email</label>
                                    <InputText class="form-control" @bind-Value="ForgotModel.Email" />
                                </div>
                                <button class="btn btn-success w-100" type="submit" disabled="@IsBusy">
                                    Envoyer
                                    @if (IsBusy)
                                    {
                                        <span class="spinner-border spinner-border-sm ms-2"></span>
                                    }
                                </button>
                            </EditForm>
                            <button class="btn btn-link w-100 mt-2" @onclick="ShowLogin">Se connecter</button>
                        }
                    }
                    else
                    {
                        <EditForm Model="LoginModel" OnValidSubmit="HandleLogin">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div class="mb-3">
                                <label>Email</label>
                                <InputText class="form-control" @bind-Value="LoginModel.Email" autocomplete="username" />
                            </div>
                            <div class="mb-3">
                                <label>Mot de passe</label>
                                <InputText class="form-control" @bind-Value="LoginModel.Password" autocomplete="current-password" type="password" />
                            </div>
                            <button class="btn btn-success w-100" type="submit" disabled="@IsBusy">
                                Connexion
                                @if (IsBusy)
                                {
                                    <span class="spinner-border spinner-border-sm ms-2"></span>
                                }
                            </button>
                        </EditForm>
                        <div class="d-flex justify-content-between mt-2">
                            <button type="button" class="btn btn-link p-0" @onclick="ShowForgotPassword">J'ai oublié mon mot de passe</button>
                            <button type="button" class="btn btn-link p-0" @onclick="ShowRequestAccess">Je n'ai pas de compte</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
